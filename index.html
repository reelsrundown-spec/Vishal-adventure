<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .controls { position: absolute; bottom: 20px; pointer-events: auto; display: flex; gap: 15px; }
        #l-ctrl { left: 20px; } #r-ctrl { right: 20px; }
        .btn { 
            width: 65px; height: 65px; background: rgba(0,0,0,0.5); color: white; 
            border-radius: 50%; border: 2px solid white; display: flex; 
            align-items: center; justify-content: center; font-weight: bold;
            -webkit-tap-highlight-color: transparent;
        }
        #lives { position: absolute; top: 15px; left: 20px; font-size: 25px; color: red; text-shadow: 1px 1px black; }
        #start-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; align-items: center; 
            justify-content: center; z-index: 100; 
        }
        #msg { 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; padding: 30px; 
            text-align: center; border-radius: 15px; z-index: 200; border: 4px solid #333;
        }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; border-radius: 10px; border: none; }
    </style>
</head>
<body>

<div id="start-overlay">
    <button style="background: #28a745; color: white;" onclick="startGame()">START GAME</button>
</div>

<div id="msg">
    <h1 id="txt"></h1>
    <button style="background: #007bff; color: white;" onclick="location.reload()">വീണ്ടും കളിക്കുക</button>
</div>

<div id="ui">
    <div id="lives">❤️❤️❤️</div>
    <div id="l-ctrl" class="controls">
        <div class="btn" id="left">LEFT</div>
        <div class="btn" id="right">RIGHT</div>
    </div>
    <div id="r-ctrl" class="controls">
        <div class="btn" id="jump">JUMP</div>
    </div>
</div>

<canvas id="g"></canvas>

<script>
const cvs = document.getElementById("g");
const ctx = cvs.getContext("2d");
let active = false;
let life = 3;

// Game Objects
let p = { x: 60, y: 0, r: 15, dy: 0, speed: 5 };
let hill = { x: 350, w: 120, h: 70 };
let enemy = { x: 600, w: 35, h: 55, hit: false, batSwing: 0 };
let goal = { x: 900 };

function startGame() {
    active = true;
    document.getElementById("start-overlay").style.display = "none";
    resize();
    loop();
}

function resize() {
    cvs.width = window.innerWidth;
    cvs.height = window.innerHeight;
    p.y = cvs.height - 70;
    goal.x = cvs.width - 60; // ഫിനിഷ് ലൈൻ സ്ക്രീനിന്റെ അറ്റത്ത് സെറ്റ് ചെയ്യുന്നു
}

window.addEventListener('resize', resize);

let keys = { l: false, r: false };
const bind = (id, k, val) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[k] = val; });
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[k] = !val; });
};

bind('left', 'l', true);
bind('right', 'r', true);
document.getElementById('jump').addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (p.y >= cvs.height - 70) p.dy = -13;
});

function loop() {
    if(!active) return;
    
    let ground = cvs.height - 50;
    ctx.clearRect(0, 0, cvs.width, cvs.height);

    // 1. Draw Ground
    ctx.fillStyle = "#228B22";
    ctx.fillRect(0, ground, cvs.width, 50);

    // 2. Draw Hill
    ctx.fillStyle = "#006400";
    ctx.beginPath();
    ctx.arc(hill.x, ground, 60, Math.PI, 0);
    ctx.fill();

    // 3. Draw Enemy (ശത്രു)
    ctx.fillStyle = "red";
    ctx.fillRect(enemy.x, ground - enemy.h, enemy.w, enemy.h);
    // Bat Animation
    ctx.fillStyle = "#444";
    if (enemy.batSwing > 0) {
        ctx.fillRect(enemy.x - 45, ground - 35, 50, 10);
        enemy.batSwing--;
    } else {
        ctx.fillRect(enemy.x - 5, ground - 75, 10, 45);
    }

    // 4. Draw Goal (ഫിനിഷ് ലൈൻ)
    ctx.fillStyle = "gold";
    ctx.fillRect(goal.x, ground - 120, 20, 120);

    // 5. Player Physics & Movement
    if(keys.l) p.x -= p.speed;
    if(keys.r) p.x += p.speed;
    
    p.dy += 0.7; // Gravity
    p.y += p.dy;

    if(p.y > ground - p.r) {
        p.y = ground - p.r;
        p.dy = 0;
    }

    // Border limit
    if(p.x < p.r) p.x = p.r;

    // 6. Collision Detection
    let dist = Math.sqrt((p.x - enemy.x)**2 + (p.y - (ground-25))**2);
    if(dist < 50 && !enemy.hit) {
        life--;
        enemy.hit = true;
        enemy.batSwing = 20; // ബാറ്റ് വീശുന്നു
        document.getElementById("lives").innerText = "❤️".repeat(life);
        p.x -= 80; p.dy = -8; // ഇടി കിട്ടി തെറിക്കുന്നു
        setTimeout(() => enemy.hit = false, 1500);
        
        if(life <= 0) {
            active = false;
            showMsg("നീ തോറ്റെടാ");
        }
    }

    // 7. Win Condition
    if(p.x > goal.x) {
        active = false;
        showMsg("അടുത്ത ഘട്ടം");
    }

    // 8. Draw Player
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = "black";
    ctx.stroke();

    requestAnimationFrame(loop);
}

function showMsg(t) {
    document.getElementById("msg").style.display = "block";
    document.getElementById("txt").innerText = t;
    document.getElementById("txt").style.color = (t === "നീ തോറ്റെടാ") ? "red" : "green";
}
</script>
</body>
</html>
